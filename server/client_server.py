import sys
import socket as sock
import select as sel

def chat_client():
    if len(sys.argv) < 3:
        print(f"Usage: python {sys.argv[0]} hostname port")
        sys.exit(-1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    client_socket = sock.socket(sock.AF_INET, sock.SOCK_STREAM)
    client_socket.settimeout(5)

    try:
        client_socket.connect((host, port))
    except Exception as e:
        print(f"Cannot reach {host} through port {port}: {e}")
        sys.exit(-1)
            
    print("Connected to remote host. You can start sending messages.")
    sys.stdout.write("> ")
    sys.stdout.flush()

    server_connection = [sys.stdin, client_socket]

    while True:
        ready_read, _, _ = sel.select(server_connection, [], [])

        for s in ready_read:
            if s == client_socket:
                try:
                    data = client_socket.recv(4096)
                    if not data:
                        print("Chat disconnected by the server.")
                        sys.exit(-1)
                    else:
                        print("Message received from server")
                        sys.stdout.write(data.decode())
                        sys.stdout.write("> ")
                        sys.stdout.flush()
                except Exception as e:
                    print(f"Error receiving data: {e}")
                    sys.exit(-1)
            else:
                msg = sys.stdin.readline()
                client_socket.send(msg.encode())
                sys.stdout.write("> ")
                sys.stdout.flush()

if __name__ == "__main__":
    chat_client()
