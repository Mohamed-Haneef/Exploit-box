import socket as sock
import select as sel
import sys

# Non-blocking I/O
host_ip = '0.0.0.0'
host_port = 4444
connected_clients = []
RECEIVE_BUFFER = 1024

def chat_server():
    global server_socket  # Declare server_socket as global so it can be accessed in other functions
    # Creating a socket object with internet module and stream connection (TCP)
    server_socket = sock.socket(sock.AF_INET, sock.SOCK_STREAM)
    server_socket.setsockopt(sock.SOL_SOCKET, sock.SO_REUSEADDR, 1)
    # Binding the socket with the given appropriate IP and port
    server_socket.bind((host_ip, host_port))
    server_socket.listen()
    server_socket.setblocking(0)
    connected_clients.append(server_socket)

    print(f"Chat server started, Listening on ip {host_ip} on port {host_port}")

    while True:
        # Block the flow for any new incoming connection
        ready_read, _, _ = sel.select(connected_clients, [], [], 0)
        
        for sock_list in ready_read:
            # If the event is on the server socket, it's an incoming connection
            if sock_list == server_socket:
                client_socket, addr = server_socket.accept()
                client_socket.setblocking(0)
                connected_clients.append(client_socket)
                print(f"Client {addr[0]}:{addr[1]} connected.")
                broadcast(server_socket, client_socket, f"Client {addr[0]}:{addr[1]} entered the chat room.\n")
            else:
                try:
                    data = sock_list.recv(RECEIVE_BUFFER)
                    if data:
                        data_decoded = data.decode().strip()
                        addr = sock_list.getpeername()
                        print(f"Received data from {addr[0]}:{addr[1]}: {data_decoded}")
                        broadcast(server_socket, sock_list, f"{addr[0]}:{addr[1]}: {data_decoded}\n")
                    else:
                        # Connection closed by client
                        addr = sock_list.getpeername()
                        print(f"Client {addr[0]}:{addr[1]} disconnected.")
                        if sock_list in connected_clients:
                            connected_clients.remove(sock_list)
                        sock_list.close()
                        broadcast(server_socket, sock_list, f"Client {addr[0]}:{addr[1]} is offline.\n")
                except Exception as e:
                    # Handle exceptions and remove the broken socket
                    addr = sock_list.getpeername()
                    print(f"Error: {e}")
                    print(f"Client {addr[0]}:{addr[1]} is offline.")
                    if sock_list in connected_clients:
                        connected_clients.remove(sock_list)
                    sock_list.close()
                    broadcast(server_socket, sock_list, f"Client {addr[0]}:{addr[1]} is offline.\n")
                    continue

def broadcast(server_socket, client_sock, message):
    for socket in connected_clients:
        if socket != server_socket and socket != client_sock:
            try:
                print(f"Sending message to {socket.getpeername()}: {message}")
                socket.send(message.encode())
            except Exception as e:
                print(f"Failed to send message to {socket.getpeername()}: {e}")
                socket.close()
                if socket in connected_clients:
                    connected_clients.remove(socket)
    # Also send the message to the client that sent it
    try:
        client_sock.send(message.encode())
    except Exception as e:
        print(f"Failed to send message to the original client: {e}")
        client_sock.close()
        if client_sock in connected_clients:
            connected_clients.remove(client_sock)

def send_message_to_all(message):
    for socket in connected_clients:
        if socket != server_socket:
            try:
                socket.send(message.encode())
            except Exception as e:
                print(f"Failed to send message to {socket.getpeername()}: {e}")
                socket.close()
                if socket in connected_clients:
                    connected_clients.remove(socket)

if __name__ == "__main__":
    try:
        chat_server()
    except KeyboardInterrupt:
        print("Chat server stopped.")
        sys.exit(0)
